;

jQuery( function() {
    $("body").on('click','[data-stopPropagation]',function (e) {
        e.stopPropagation();
    });
    
    // 滚动条
    const ps = new PerfectScrollbar('.kkadmin-layout-sidebar-scroll', {
		swipeEasing: false,
		suppressScrollX: true
	});
    
    // 侧边栏
    $(".kkadmin-aside-toggler").bind('click', function(){
        $('.kkadmin-layout-sidebar').toggleClass('kkadmin-aside-open');
        $("body").toggleClass('kkadmin-layout-sidebar-close');
        
        if ($('.kkadmin-mask-modal').length == 0) {
            $('<div class="kkadmin-mask-modal"></div>').prependTo('body');
        } else {
            $( '.kkadmin-mask-modal' ).remove();
        }
        $('.kkadmin-mask-modal').on( 'click', function() {
            $( this ).remove();
        	$('.kkadmin-layout-sidebar').toggleClass('kkadmin-aside-open');
            $('body').toggleClass('kkadmin-layout-sidebar-close');
        });
    });
    
	// 侧边栏导航
	$( '.nav-item-has-subnav > a' ).on( 'click', function() {
		$subnavToggle = jQuery( this );
		$navHasSubnav = $subnavToggle.parent();
        $topHasSubNav = $subnavToggle.parents('.nav-item-has-subnav').last();
		$subnav       = $navHasSubnav.find('.nav-subnav').first();
        $viSubHeight  = $navHasSubnav.siblings().find('.nav-subnav:visible').outerHeight();
        $scrollBox    = $('.kkadmin-layout-sidebar-scroll');
		$navHasSubnav.siblings().find('.nav-subnav:visible').slideUp(500).parent().removeClass('open');
		$subnav.slideToggle( 300, function() {
			$navHasSubnav.toggleClass( 'open' );
			// 新增滚动条处理
			var scrollHeight  = 0;
			    pervTotal     = $topHasSubNav.prevAll().length,
			    boxHeight     = $scrollBox.outerHeight(),
		        innerHeight   = $('.sidebar-main').outerHeight(),
                thisScroll    = $scrollBox.scrollTop(),
                thisSubHeight = $(this).outerHeight(),
                footHeight    = 121;
			
			if (footHeight + innerHeight - boxHeight >= (pervTotal * 48)) {
			    scrollHeight = pervTotal * 48;
			}
            if ($subnavToggle.parents('.nav-item-has-subnav').length == 1) {
                $scrollBox.animate({scrollTop: scrollHeight}, 300);
            } else {
                // 子菜单操作
                if (typeof($viSubHeight) != 'undefined' && $viSubHeight != null) {
                    scrollHeight = thisScroll + thisSubHeight - $viSubHeight;
                    $scrollBox.animate({scrollTop: scrollHeight}, 300);
                } else {
                    if ((thisScroll + boxHeight - $scrollBox[0].scrollHeight) == 0) {
                        scrollHeight = thisScroll - thisSubHeight;
                        $scrollBox.animate({scrollTop: scrollHeight}, 300);
                    }
                }
            }
		});
	});
    
    // 提示
	if($('[data-toggle="tooltip"]')[0]) {
		$('[data-toggle="tooltip"]').tooltip({
			"container" : 'body',
		});
	}
    
    // 弹出框
    if($('[data-toggle="popover"]')[0]) {
        $('[data-toggle="popover"]').popover();
    }
    
    // 标签
	if($('.js-tags-input')[0]) {
		$('.js-tags-input').tagsInput({
			height: '36px',
			width: '100%',
			defaultText: $('.js-tags-input').attr("placeholder"),
			removeWithBackspace: true,
			delimiter: [',']
		});
	}
    
    // 时间选择
	jQuery('.js-datetimepicker').each(function() {
		var $input = jQuery(this);
		$input.datetimepicker({
			format: $input.data('format') ? $input.data('format') : false,
			useCurrent: $input.data('use-current') ? $input.data('use-current') : false,
			locale: moment.locale('' + ($input.data('locale') ? $input.data('locale') : '') + ''),
			showTodayButton: $input.data('show-today-button') ? $input.data('show-today-button') : false,
			showClear: $input.data('show-clear') ? $input.data('show-clear') : false,
			showClose: $input.data('show-close') ? $input.data('show-close') : false,
			sideBySide: $input.data('side-by-side') ? $input.data('side-by-side') : false,
			inline: $input.data('inline') ? $input.data('inline') : false,
		});
	});
    
    // 日期选择
	jQuery('.js-datepicker').each(function() {
	    var $input = jQuery(this);
		$input.datepicker({
			weekStart: 1,
			autoclose: true,
			todayHighlight: true,
			language: 'zh-CN',
		});
	});
    
    // 颜色选取
	jQuery('.js-colorpicker').each(function() {
		var $colorpicker = jQuery(this);
		var $colorpickerMode = $colorpicker.data('colorpicker-mode') ? $colorpicker.data('colorpicker-mode') : 'hex';
		var $colorpickerinline = $colorpicker.data('colorpicker-inline') ? true: false;
		$colorpicker.colorpicker({
			'format': $colorpickerMode,
			'inline': $colorpickerinline
		});
	});
    // 复选框全选
	$("#check-all").change(function () {
		$("input[type='checkbox']").prop('checked', $(this).prop("checked"));
	});
	$("button[widget-type='upload']").click(function () {
		var crowd_name = $.trim($('#upload_name').val());
		var crowd_desc = $.trim($('#upload_desc').val());
		var crowd_file = this.files[0];
		var target = $(this).attr('data-target');
		var targettype = $(this).attr('target-type');

		var formData = new FormData();
		formData.append("_token", $('meta[name="csrf-token"]').attr('content'));
		formData.append("image",crowd_file);
		$.ajax({
			url:'/admin/upload/',
			dataType:'json',
			type:'POST',
			async: false,
			data: JSON.stringify(formData),
			processData : false, // 使数据不做处理
			contentType : false, // 不要设置Content-Type请求头
			success: function(res){
				success(res.message);
				if (target && targettype == 'input') {
					$("#"+target).val(res.data.url);
				}
				if (target && targettype == 'preview') {
					$("#"+target).attr('src', res.data.url);
				}
			},
			error:function(response){
				console.log(response);
			}
		});
	});

	$("input[widget-type='auto-upload']").on("change",function(){
		//使用类型判断浏览器是否支持base64转换
		if (typeof (FileReader) === 'undefined') {
			alert("抱歉，你的浏览器不支持文件读取，请更新浏览器操作！");
		}else{
			//000.获取文件
			var file = this.files[0];
			var fileSize = this.files[0].size;	//文件大小
			var size = fileSize / 1024*1024; 	//和上面那句一样1.5M约等于160 0000
			//001.文件格式校验
			if (!/image\/\w+/.test(file.type)) {
				alert("请确保文件为图像类型");
				//格式不对，就禁止上传操作【按钮禁用】
				$("#upbtn").attr({"disabled":"disabled"});
			}else if(size>2000000){
				alert("上传图片大小不得大于1M");
				return false;
			}else{
				var target = $(this).attr('data-target');
				var targettype = $(this).attr('target-type');

				var crowd_file = this.files[0];
				var formData = new FormData();
				formData.append("_token", $('meta[name="csrf-token"]').attr('content'));
				formData.append("image",crowd_file);

				$.ajax({
					url:'/admin/upload/image',
					data:formData,
					cache: false,
					dataType: 'json',
					contentType: false,//必须false才会避开jQuery对 formdata 的默认处理 XMLHttpRequest会对 formdata 进行正确的处理
					processData: false,//必须false才会自动加上正确的Content-Type
					type:'post',
					success:function(res){
						if (res.errorNo == 0) {
							success(res.message);
							if (target && targettype == 'input') {
								$("#"+target).val(res.data.url);
							}
							if (target && targettype == 'preview') {
								var item='<li class="col-xs-4 col-sm-3 col-md-2">\n' +
									'                        <figure>\n' +
									'                          <img src="' + res.data.url + '" alt="">\n' +
									'                          <figcaption>\n' +
									'                            <a class="btn btn-round btn-square btn-primary" href="#!"><i class="mdi mdi-eye"></i></a>\n' +
									'                            <a class="btn btn-round btn-square btn-danger" href="#!"><i class="mdi mdi-delete"></i></a>\n' +
									'                          </figcaption>\n' +
									'                        </figure>\n' +
									'                      </li>';
								$("#"+target).prepend(item);
							}
						} else {
							error(res.message);
						}
					},error:function(e){
						console.log(e);
					}
				});
			}
		}

		return true;
	});
    
    // 设置主题配色
	setTheme = function(input_name, data_name) {
	    $("input[name='"+input_name+"']").click(function(){
	        $('body').attr(data_name, $(this).val());
	    });
	}
	setTheme('site_theme', 'data-theme');
	setTheme('logo_bg', 'data-logobg');
	setTheme('header_bg', 'data-headerbg');
	setTheme('sidebar_bg', 'data-sidebarbg');
});